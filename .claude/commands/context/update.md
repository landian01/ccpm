---
allowed-tools: Bash, Read, Write, LS
---

# 更新上下文

此命令更新 `.claude/context/` 中的项目上下文文档，以反映项目的当前状态。在每次开发会话结束时运行此命令以保持上下文准确。

## 必要规则

**重要：** 执行此命令前，请阅读并遵循：
- `.claude/rules/datetime.md` - 用于获取真实的当前日期/时间

## 预检清单

在继续之前，请完成这些验证步骤。
不要用预检进度来打扰用户（"我不会..."）。只需执行它们并继续。

### 1. 上下文验证
- 运行：`ls -la .claude/context/ 2>/dev/null`
- 如果目录不存在或为空：
  - 告诉用户："❌ 没有上下文可更新。请先运行 /context:create"
  - 优雅退出
- 统计现有文件：`ls -1 .claude/context/*.md 2>/dev/null | wc -l`
- 报告："📁 发现 {count} 个上下文文件需要检查更新"

### 2. 变更检测

收集已变更的信息：

**Git 变更：**
- 运行：`git status --short` 查看未提交的变更
- 运行：`git log --oneline -10` 查看最近的提交
- 运行：`git diff --stat HEAD~5..HEAD 2>/dev/null` 查看最近变更的文件

**文件修改：**
- 检查上下文文件年龄：`find .claude/context -name "*.md" -type f -exec ls -lt {} + | head -5`
- 记录哪些上下文文件最旧，可能需要更新

**依赖变更：**
- Node.js：`git diff HEAD~5..HEAD package.json 2>/dev/null`
- Python：`git diff HEAD~5..HEAD requirements.txt 2>/dev/null`
- 检查是否添加了新依赖或版本发生了变化

### 3. 获取当前日期时间
- 运行：`date -u +"%Y-%m-%dT%H:%M:%SZ"`
- 存储用于更新已修改文件中的 `last_updated` 字段

## 指令

### 1. 系统性变更分析

为每个上下文文件确定是否需要更新：

**系统性地检查每个文件：**
#### `progress.md` - **始终更新**
  - 检查：最近的提交、当前分支、未提交的变更
  - 更新：最新的已完成工作、当前的阻塞点、下一步骤
  - 运行：`git log --oneline -5` 获取最近的提交消息
  - 如果适用，包含完成百分比

#### `project-structure.md` - **变更时更新**
  - 检查：`git diff --name-status HEAD~10..HEAD | grep -E '^A'` 查看新文件
  - 更新：新目录、移动的文件、结构重组
  - 仅在发生重大结构变更时更新

#### `tech-context.md` - **依赖变更时更新**
  - 检查：包文件中的新依赖或版本变更
  - 更新：新库、升级版本、新开发工具
  - 包含安全更新或破坏性变更

#### `system-patterns.md` - **架构变更时更新**
  - 检查：新的设计模式、架构决策
  - 更新：采用的新模式、完成的代码重构
  - 仅在发生重大架构变更时更新

#### `product-context.md` - **需求变更时更新**
  - 检查：实现的新功能、纳入的用户反馈
  - 更新：新的用户故事、变更的需求
  - 包含产品方向的任何转向

#### `project-brief.md` - **很少更新**
  - 检查：仅在项目基本目标发生变化时
  - 更新：主要范围变更、新目标
  - 通常保持稳定

#### `project-overview.md` - **重大里程碑时更新**
  - 检查：完成的主要功能、重大进展
  - 更新：功能状态、能力变更
  - 在达到项目里程碑时更新

#### `project-vision.md` - **很少更新**
  - 检查：战略方向变更
  - 更新：仅在重大愿景转变时
  - 通常保持稳定

#### `project-style-guide.md` - **约定变更时更新**
  - 检查：新的代码检查规则、风格决策
  - 更新：约定变更、采用的新模式
  - 包含新模式的示例
### 2. 智能更新策略

**对于每个需要更新的文件：**

1. **读取现有文件** 以了解当前内容
2. **识别需要更新的特定部分**
3. **保留 frontmatter** 但更新 `last_updated` 字段：
   ```yaml
   ---
   created: [保留原值]
   last_updated: [使用日期命令的真实日期时间]
   version: [主要更新时递增，例如 1.0 → 1.1]
   author: Claude Code PM System
   ---
   ```
4. **进行针对性更新** - 不要重写整个文件
5. **如果重大变更，在底部添加更新说明**：
   ```markdown
   ## 更新历史
   - {日期}: {变更摘要}
   ```

### 3. 更新验证

更新每个文件后：
- 验证文件仍具有有效的 frontmatter
- 检查文件大小合理（未损坏）
- 确保 markdown 格式保持完整
- 确认更新准确反映了变更

### 4. 跳过优化

**跳过不需要更新的文件：**
- 如果未检测到相关变更，跳过该文件
- 在摘要中报告跳过的文件
- 如果内容未变更，不要更新时间戳
- 这可以保留准确的"最后修改"信息

### 5. 错误处理

**常见问题：**
- **文件锁定：** "❌ 无法更新 {file} - 可能在编辑器中打开"
- **权限被拒：** "❌ 无法写入 {file} - 检查权限"
- **文件损坏：** "⚠️ {file} 似乎已损坏 - 跳过更新"
- **磁盘空间：** "❌ 磁盘空间不足，无法更新"

如果更新失败：
- 报告哪些文件成功更新
- 记录哪些文件失败及原因
- 保留原始文件（不要留下损坏状态）

### 6. 更新摘要

提供详细的更新摘要：

```
🔄 上下文更新完成

📊 更新统计：
  - 扫描文件数：{total_count}
  - 已更新文件数：{updated_count}
  - 跳过文件数：{skipped_count}（无需变更）
  - 错误数：{error_count}

📝 已更新文件：
  ✅ progress.md - 更新了最近的提交、当前状态
  ✅ tech-context.md - 添加了 3 个新依赖
  ✅ project-structure.md - 记录了新的 /utils 目录

⏭️ 跳过文件（无变更）：
  - project-brief.md（最后更新：5 天前）
  - project-vision.md（最后更新：2 周前）
  - system-patterns.md（最后更新：3 天前）

⚠️ 问题：
  {任何警告或错误}

⏰ 最后更新：{timestamp}
🔄 下一步：定期运行此命令以保持上下文最新
💡 提示：重大变更？考虑运行 /context:create 进行完整刷新
```

### 7. 增量更新跟踪

**跟踪已更新的内容：**
- 记录每个文件中修改了哪些部分
- 保持变更集中且精准
- 不要重新生成未变更的内容
- 保留格式和结构

### 8. 性能优化

对于大型项目：
- 尽可能并行处理文件
- 显示进度："正在更新上下文文件... {current}/{total}"
- 跳过超大文件并发出警告
- 使用 git diff 快速识别变更区域

## 上下文收集命令

使用这些命令检测变更：
- 上下文目录：`.claude/context/`
- 当前 git 状态：`git status --short`
- 最近提交：`git log --oneline -10`
- 变更文件：`git diff --name-only HEAD~5..HEAD 2>/dev/null`
- 分支信息：`git branch --show-current`
- 未提交变更：`git diff --stat`
- 新的未跟踪文件：`git ls-files --others --exclude-standard | head -10`
- 依赖变更：检查 package.json、requirements.txt 等

## 重要注意事项

- **仅更新实际变更的文件** - 保留准确的时间戳
- **始终使用真实的日期时间** 从系统时钟获取 `last_updated`
- **进行精准更新** - 不要重新生成整个文件
- **验证每个更新** - 确保文件保持有效
- **提供详细摘要** - 显示变更内容和未变更内容
- **优雅处理错误** - 不要损坏现有上下文

$ARGUMENTS
