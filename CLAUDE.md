# CLAUDE.md

此文件为 Claude Code (claude.ai/code) 在此代码库中工作时提供指导。

> 仔细思考并实现最简洁的解决方案，尽可能少地改变代码。

## 核心项目管理系统

这是 **Claude Code 项目管理 (CCPM)** 系统 - 一个使用规范驱动开发、GitHub Issues、Git 工作树和并行 AI 代理来更快地交付更好软件的工作流框架。

### 系统架构

```
.claude/
├── agents/            # 面向任务的代理，用于上下文保存
├── commands/          # 命令定义（markdown 文件）
│   ├── context/       # 上下文管理命令  
│   ├── pm/           # 项目管理命令（核心系统）
│   └── testing/      # 测试执行命令
├── context/          # 项目范围的上下文文件
├── epics/            # PM 的本地工作区（添加到 .gitignore）
├── prds/             # 产品需求文档
├── rules/            # 系统行为规则
└── scripts/          # 命令执行的 Shell 脚本
```

## 基本命令

### 初始设置
```bash
/pm:init              # 安装依赖项并配置 GitHub
/context:create       # 创建初始项目上下文
```

### 开发工作流
```bash
/pm:prd-new <name>    # 启动全面的 PRD 头脑风暴
/pm:prd-parse <name>  # 将 PRD 转换为技术实施计划
/pm:epic-oneshot <name> # 一个命令完成分解并推送到 GitHub
/pm:issue-start <id>  # 为任务启动专业化代理
/pm:next             # 获取下一个优先级任务及史诗上下文
```

### 常见开发任务
```bash
/testing:run          # 执行智能分析测试
/context:prime        # 将上下文加载到当前对话中
/context:update       # 使用最近的更改刷新上下文
```

## 上下文优化的代理系统

系统使用专业化代理来保护主对话免受信息过载：

- **code-analyzer**: 在多个文件中查找错误而不污染主上下文
- **file-analyzer**: 读取并总结冗长文件（日志、输出、配置）
- **test-runner**: 执行测试而不将输出转储到主线程
- **parallel-worker**: 在单个问题内协调多个并行工作流

### 代理使用规则
1. **运行测试时始终使用 test-runner 代理**
2. **分析大文件时始终使用 file-analyzer 代理**
3. **跟踪逻辑流程或搜索错误时始终使用 code-analyzer 代理**
4. 代理返回简洁摘要（已处理内容的 10-20%）
5. 实施细节保留在代理中，不在主线程中

## 并行执行系统

### 关键原则：Issues 不是原子的
一个"实现用户认证"问题变成：
- **代理 1**: 数据库表和迁移
- **代理 2**: 服务层和业务逻辑
- **代理 3**: API 端点和中间件
- **代理 4**: UI 组件和表单
- **代理 5**: 测试套件和文档

全部在同一个工作树中**同时**运行。

### 协调规则
- 代理在不同文件上工作以避免冲突
- 每个流的原子提交和清晰消息
- 通过提交历史和进度文件进行通信
- 人工解决冲突，代理永不自动合并

## 核心理念

### 禁止凭感觉编码
**每行代码都必须追溯到规范。**

5 阶段纪律：
1. **头脑风暴** - 思考得比舒适区更深
2. **文档** - 编写不留解释空间的规范
3. **计划** - 制定明确的技术决策和架构
4. **执行** - 精确构建指定的内容
5. **跟踪** - 在每一步维护透明的进度

### 错误处理理念
- **快速失败** 对于关键配置（缺少文本模型）
- **记录并继续** 对于可选功能（提取模型）
- **优雅降级** 当外部服务不可用时
- **用户友好的消息** 通过弹性层

## 测试指南

- 测试执行始终使用 test-runner 代理
- 永远不要模拟任何东西 - 使用真实服务
- 在当前测试完成之前不要进行下一个测试
- 如果测试失败，在决定重构代码库之前检查测试结构
- 测试应该详细以便调试

## 标准模式

### 命令结构
所有命令都遵循一致的模式：
- 前置元数据指定允许的工具：`allowed-tools: Read, Write, LS, Bash, Task`
- 前提条件快速失败
- 带有解决方案的清晰错误消息
- 专注于结果的最小输出

### 文件操作
- 无需询问即创建目录：`mkdir -p .claude/{directory} 2>/dev/null`
- 信任文件系统通常正常工作
- 使用合理的默认值，优雅地回退

### GitHub 集成
- 使用 **gh-sub-issue 扩展** 进行适当的父子关系
- 如果扩展未安装则回退到任务列表
- 史诗问题自动跟踪子任务完成
- 标签提供组织（`epic:feature`、`task:feature`）

## 开发规则

### 绝对规则
- 没有部分实现
- 没有带有"// 这是临时简化的"注释的简化
- 没有代码重复 - 检查现有代码库以重用函数
- 没有死代码 - 要么使用要么完全删除
- 为每个函数实现测试
- 没有作弊测试 - 测试必须准确且设计用于揭示缺陷
- 没有不一致的命名 - 阅读现有代码库的命名模式
- 没有过度工程 - 当简单函数有效时，不要添加不必要的抽象
- 没有混合关注点 - 验证逻辑、数据库查询等的适当分离
- 没有资源泄漏 - 关闭数据库连接、清除超时、移除事件监听器

### 上下文管理
- 使用专业化代理进行繁重工作以保护主线程上下文
- 保持主对话战略性，实施细节在代理中
- 重大更改后定期更新上下文
- `.claude/context/` 中的上下文文件用于项目范围的知识

## 分支和工作树操作

### Git 工作树策略
- 每个史诗获得自己的工作树：`../epic-{name}/`
- 并行代理在同一工作树的不同文件上工作
- 史诗完成时干净合并回主分支
- 并行流之间没有冲突

### 提交策略
- 每个流的小的、原子的提交
- 链接到问题的清晰提交消息
- 定期拉取以保持同步
- 任何冲突的人工干预

## 快速参考

### 状态指示器
- ✅ 成功（少量使用）
- ❌ 错误（始终带有解决方案）
- ⚠️ 警告（仅在需要操作时）
- 常规输出不使用表情符号

### 常见文件模式
- 任务在分解期间以 `001.md`、`002.md` 开始
- GitHub 同步后，重命名为 `{issue-id}.md`（例如 `1234.md`）
- 进度文件：`.claude/epics/{epic}/updates/{issue}/stream-{X}.md`

### GitHub Issue 生命周期
1. PRD 创建（本地）
2. 史诗规划（本地）
3. 任务分解（本地 + GitHub 同步）
4. 并行执行（本地与进度同步）
5. 最终交付物（GitHub）

该系统专为希望**通过更系统化来更快交付**的团队设计，使用 AI 代理处理复杂性，同时保持从想法到生产的完整可追溯性。